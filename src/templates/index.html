<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UltiUI - Ultimaker S3 HMI</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .success-message {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem;
            background-color: #10B981;
            color: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .error-message {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem;
            background-color: #EF4444;
            color: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .camera-container {
            position: relative;
            width: 100%;
            background-color: #1a1a1a;
            border-radius: 0.5rem;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .camera-feed {
            width: 100%;
            height: auto;
            display: block;
            pointer-events: none;
            background-color: #1a1a1a;
        }
        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 1.25rem;
        }
        .stat-card {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        .stat-title {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }
        .stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">UltiUI</h1>
            <p class="text-gray-600">Ultimaker S3 Web Interface</p>
        </header>

        <main class="max-w-4xl mx-auto">
            <!-- Camera Stream Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Camera Feed</h2>
                <div class="camera-container">
                    <img id="camera-feed" class="camera-feed" src="" alt="Printer Camera Feed">
                    <div id="camera-overlay" class="camera-overlay">
                        <span>Camera feed not available</span>
                    </div>
                </div>
            </div>

            <!-- Current Job Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Current Job</h2>
                    <span id="job-status" class="px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">No Job</span>
                </div>
                
                <div id="job-details" class="hidden">
                    <div class="mb-6">
                        <div class="stat-title">File Name</div>
                        <div id="job-name" class="stat-value text-lg"></div>
                    </div>

                    <div class="mb-6">
                        <div class="stat-title">Progress</div>
                        <div class="relative pt-1">
                            <div class="flex mb-2 items-center justify-between">
                                <div>
                                    <span id="progress-text" class="text-xs font-semibold inline-block text-blue-600">
                                        0%
                                    </span>
                                </div>
                                <div class="text-right">
                                    <span id="time-remaining" class="text-xs font-semibold inline-block text-gray-600">
                                        --:--:-- remaining
                                    </span>
                                </div>
                            </div>
                            <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-blue-200">
                                <div id="progress-bar" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="stat-card">
                            <div class="stat-title">Time Elapsed</div>
                            <div id="time-elapsed" class="stat-value">--:--:--</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Estimated Total Time</div>
                            <div id="time-total" class="stat-value">--:--:--</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Started At</div>
                            <div id="time-started" class="stat-value text-base">--</div>
                        </div>
                    </div>
                </div>

                <div id="no-job-message" class="text-gray-500 text-center py-4">
                    No active print job
                </div>
            </div>

            <!-- Printer Stats Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Printer Status</h2>
                    <span id="printer-status" class="px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">Unknown</span>
                </div>
                
                <!-- Print Core Stats -->
                <div class="mb-8">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">Print Core Statistics</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Print Core 0 -->
                        <div class="stat-card">
                            <div class="flex justify-between items-center mb-2">
                                <div class="stat-title mb-0">Print Core 0</div>
                                <div class="text-sm text-gray-500" id="core0-usage-time">Usage: --:--:--</div>
                            </div>
                            <div class="space-y-2">
                                <div>
                                    <span class="text-sm text-gray-600">Last Extrusion:</span>
                                    <div class="stat-value text-base" id="core0-last-extrusion">-- mm in -- s</div>
                                </div>
                                <div>
                                    <span class="text-sm text-gray-600">Remaining Length:</span>
                                    <div class="stat-value text-base" id="core0-remaining">-- mm</div>
                                </div>
                            </div>
                        </div>
                        <!-- Print Core 1 -->
                        <div class="stat-card">
                            <div class="flex justify-between items-center mb-2">
                                <div class="stat-title mb-0">Print Core 1</div>
                                <div class="text-sm text-gray-500" id="core1-usage-time">Usage: --:--:--</div>
                            </div>
                            <div class="space-y-2">
                                <div>
                                    <span class="text-sm text-gray-600">Last Extrusion:</span>
                                    <div class="stat-value text-base" id="core1-last-extrusion">-- mm in -- s</div>
                                </div>
                                <div>
                                    <span class="text-sm text-gray-600">Remaining Length:</span>
                                    <div class="stat-value text-base" id="core1-remaining">-- mm</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Temperature Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="stat-card">
                        <div class="stat-title">Bed Temperature</div>
                        <div class="stat-value">
                            <span id="bed-temp">--</span>째C / 
                            <span id="bed-target" class="text-gray-500">--</span>째C
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Extruder 1 Temperature</div>
                        <div class="stat-value">
                            <span id="ext1-temp">--</span>째C / 
                            <span id="ext1-target" class="text-gray-500">--</span>째C
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Extruder 2 Temperature</div>
                        <div class="stat-value">
                            <span id="ext2-temp">--</span>째C / 
                            <span id="ext2-target" class="text-gray-500">--</span>째C
                        </div>
                    </div>
                </div>

                <!-- Position Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="stat-card">
                        <div class="stat-title">Position</div>
                        <div class="stat-value text-base">
                            X: <span id="pos-x">--</span>mm<br>
                            Y: <span id="pos-y">--</span>mm<br>
                            Z: <span id="pos-z">--</span>mm
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Fan Speed</div>
                        <div class="stat-value"><span id="fan-speed">--</span>%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">LED Status</div>
                        <div class="stat-value">
                            Brightness: <span id="led-brightness">--</span>%
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Printer Configuration</h2>
                
                <div class="mb-6">
                    <label for="printer-ip" class="block text-sm font-medium text-gray-700 mb-2">
                        Printer IP Address
                    </label>
                    <div class="flex gap-4">
                        <input type="text" 
                               id="printer-ip" 
                               class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                               placeholder="Enter printer IP address (e.g., 192.168.1.100)">
                        <button onclick="saveConfig()" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Save
                        </button>
                    </div>
                </div>

                <div class="border-t pt-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">Connection Status</h3>
                    <div id="connection-status" class="flex items-center">
                        <div id="status-indicator" class="w-3 h-3 rounded-full bg-gray-400 mr-2"></div>
                        <span id="status-text" class="text-gray-600">Not Connected</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="success-message" class="success-message">
        Configuration saved successfully!
    </div>

    <div id="error-message" class="error-message">
        Error message here
    </div>

    <script>
        let statsInterval;
        let jobInterval;
        let printCoresInterval;

        // Format seconds to HH:MM:SS
        function formatTime(seconds) {
            if (!seconds) return '--:--:--';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        // Format date to local time
        function formatDate(dateString) {
            if (!dateString) return '--';
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        // Load current configuration
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                document.getElementById('printer-ip').value = config.printer_ip || '';
                if (config.printer_ip) {
                    testConnection();
                }
            } catch (error) {
                console.error('Error loading configuration:', error);
                showError('Error loading configuration');
            }
        }

        // Save configuration
        async function saveConfig() {
            const printerIp = document.getElementById('printer-ip').value;
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ printer_ip: printerIp }),
                });
                
                if (response.ok) {
                    showSuccess('Configuration saved successfully!');
                    testConnection();
                } else {
                    const data = await response.json();
                    showError(data.message || 'Error saving configuration');
                }
            } catch (error) {
                console.error('Error saving configuration:', error);
                showError('Error saving configuration');
            }
        }

        // Update printer stats
        async function updatePrinterStats() {
            try {
                const response = await fetch('/api/printer-stats');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Printer data received:', data); // Debug log

                // Update status
                const statusElement = document.getElementById('printer-status');
                statusElement.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
                statusElement.className = `px-3 py-1 rounded-full text-sm font-medium ${getStatusClass(data.status)}`;

                // Update temperatures with null checks
                if (data.bed && data.bed.temperature) {
                    document.getElementById('bed-temp').textContent = data.bed.temperature.current.toFixed(1);
                    document.getElementById('bed-target').textContent = data.bed.temperature.target;
                }

                if (data.heads && data.heads[0] && data.heads[0].extruders) {
                    if (data.heads[0].extruders[0] && data.heads[0].extruders[0].hotend) {
                        document.getElementById('ext1-temp').textContent = data.heads[0].extruders[0].hotend.temperature.current.toFixed(1);
                        document.getElementById('ext1-target').textContent = data.heads[0].extruders[0].hotend.temperature.target;
                    }
                    if (data.heads[0].extruders[1] && data.heads[0].extruders[1].hotend) {
                        document.getElementById('ext2-temp').textContent = data.heads[0].extruders[1].hotend.temperature.current.toFixed(1);
                        document.getElementById('ext2-target').textContent = data.heads[0].extruders[1].hotend.temperature.target;
                    }
                }

                // Update position with null checks
                if (data.heads && data.heads[0] && data.heads[0].position) {
                    document.getElementById('pos-x').textContent = data.heads[0].position.x.toFixed(1);
                    document.getElementById('pos-y').textContent = data.heads[0].position.y.toFixed(1);
                    document.getElementById('pos-z').textContent = data.heads[0].position.z.toFixed(1);
                }

                // Update fan and LED with null checks
                if (data.heads && data.heads[0]) {
                    document.getElementById('fan-speed').textContent = data.heads[0].fan;
                }
                if (data.led) {
                    document.getElementById('led-brightness').textContent = data.led.brightness;
                }

            } catch (error) {
                console.error('Error updating printer stats:', error);
                // Update status to show error
                const statusElement = document.getElementById('printer-status');
                statusElement.textContent = 'Error';
                statusElement.className = 'px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800';
            }
        }

        function getStatusClass(status) {
            switch (status) {
                case 'printing':
                    return 'bg-green-100 text-green-800';
                case 'idle':
                    return 'bg-blue-100 text-blue-800';
                case 'error':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        // Test connection to printer
        async function testConnection() {
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const cameraFeed = document.getElementById('camera-feed');
            const cameraOverlay = document.getElementById('camera-overlay');
            const printerIp = document.getElementById('printer-ip').value;
            
            statusIndicator.className = 'w-3 h-3 rounded-full bg-yellow-400 mr-2';
            statusText.textContent = 'Testing connection...';
            
            try {
                const response = await fetch('/api/test-connection');
                const data = await response.json();
                
                if (data.connected) {
                    statusIndicator.className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
                    statusText.textContent = 'Connected';
                    
                    // Update camera feed
                    if (printerIp) {
                        cameraFeed.src = `http://${printerIp}:8080/?action=stream`;
                        cameraOverlay.style.display = 'none';
                        
                        // Start updating printer stats
                        clearInterval(statsInterval);
                        updatePrinterStats();
                        statsInterval = setInterval(updatePrinterStats, 1000);
                    } else {
                        cameraFeed.src = '';
                        cameraOverlay.style.display = 'flex';
                    }
                } else {
                    statusIndicator.className = 'w-3 h-3 rounded-full bg-red-500 mr-2';
                    statusText.textContent = `Not Connected: ${data.message}`;
                    
                    // Hide camera feed and stop stats updates
                    cameraFeed.src = '';
                    cameraOverlay.style.display = 'flex';
                    clearInterval(statsInterval);
                }
            } catch (error) {
                console.error('Error testing connection:', error);
                statusIndicator.className = 'w-3 h-3 rounded-full bg-red-500 mr-2';
                statusText.textContent = 'Connection test failed';
                
                // Hide camera feed and stop stats updates
                cameraFeed.src = '';
                cameraOverlay.style.display = 'flex';
                clearInterval(statsInterval);
            }
        }

        // Update print job information
        async function updatePrintJob() {
            try {
                const response = await fetch('/api/print-job');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const jobDetails = document.getElementById('job-details');
                const noJobMessage = document.getElementById('no-job-message');
                const jobStatus = document.getElementById('job-status');

                if (data.state) {
                    jobDetails.classList.remove('hidden');
                    noJobMessage.classList.add('hidden');
                    
                    // Update job status
                    jobStatus.textContent = data.state.charAt(0).toUpperCase() + data.state.slice(1);
                    jobStatus.className = `px-3 py-1 rounded-full text-sm font-medium ${getJobStatusClass(data.state)}`;

                    // Update job name
                    document.getElementById('job-name').textContent = data.name || 'Unnamed Job';

                    // Update progress
                    const progress = Math.round((data.progress || 0) * 100);
                    document.getElementById('progress-text').textContent = `${progress}%`;
                    document.getElementById('progress-bar').style.width = `${progress}%`;

                    // Update times
                    document.getElementById('time-elapsed').textContent = formatTime(data.time_elapsed);
                    document.getElementById('time-total').textContent = formatTime(data.time_total);
                    document.getElementById('time-started').textContent = formatDate(data.datetime_started);

                    // Calculate and update remaining time
                    const remaining = data.time_total - data.time_elapsed;
                    document.getElementById('time-remaining').textContent = `${formatTime(remaining)} remaining`;
                } else {
                    jobDetails.classList.add('hidden');
                    noJobMessage.classList.remove('hidden');
                    jobStatus.textContent = 'No Job';
                    jobStatus.className = 'px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800';
                }

            } catch (error) {
                console.error('Error updating print job:', error);
            }
        }

        function getJobStatusClass(status) {
            switch (status) {
                case 'printing':
                    return 'bg-green-100 text-green-800';
                case 'paused':
                    return 'bg-yellow-100 text-yellow-800';
                case 'error':
                    return 'bg-red-100 text-red-800';
                case 'finished':
                    return 'bg-blue-100 text-blue-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        // Update print core information
        async function updatePrintCores() {
            try {
                const response = await fetch('/api/print-cores');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Update Print Core 0
                if (data['0'].last_extrusion) {
                    document.getElementById('core0-last-extrusion').textContent = 
                        `${data['0'].last_extrusion.amount.toFixed(2)} mm in ${data['0'].last_extrusion.time.toFixed(1)} s`;
                    document.getElementById('core0-remaining').textContent = 
                        `${data['0'].remaining_length.toFixed(0)} mm`;
                    document.getElementById('core0-usage-time').textContent = 
                        `Usage: ${formatTime(data['0'].usage_duration)}`;
                }

                // Update Print Core 1
                if (data['1'].last_extrusion) {
                    document.getElementById('core1-last-extrusion').textContent = 
                        `${data['1'].last_extrusion.amount.toFixed(2)} mm in ${data['1'].last_extrusion.time.toFixed(1)} s`;
                    document.getElementById('core1-remaining').textContent = 
                        `${data['1'].remaining_length.toFixed(0)} mm`;
                    document.getElementById('core1-usage-time').textContent = 
                        `Usage: ${formatTime(data['1'].usage_duration)}`;
                }

            } catch (error) {
                console.error('Error updating print cores:', error);
            }
        }

        // Show success message
        function showSuccess(message) {
            const successMessage = document.getElementById('success-message');
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 3000);
        }

        // Show error message
        function showError(message) {
            const errorMessage = document.getElementById('error-message');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 3000);
        }

        // Load configuration when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            // Start updating printer stats, job status, and print cores immediately and every second
            console.log('Starting updates...'); // Debug log
            updatePrinterStats();
            updatePrintJob();
            updatePrintCores();
            statsInterval = setInterval(updatePrinterStats, 1000);
            jobInterval = setInterval(updatePrintJob, 1000);
            printCoresInterval = setInterval(updatePrintCores, 1000);
        });

        // Cleanup intervals when page is unloaded
        window.addEventListener('beforeunload', () => {
            clearInterval(statsInterval);
            clearInterval(jobInterval);
            clearInterval(printCoresInterval);
        });
    </script>
</body>
</html> 